 /*
  * UADE's audio state machine emulation
  *
  * Copyright 1995, 1996, 1997 Bernd Schmidt
  * Copyright 1996 Marcus Sundberg
  * Copyright 1996 Manfred Thole
  * Copyright 2005 Heikki Orsila
  * Copyright 2005 Antti S. Lankila
  */

#include <math.h>

#include "sysconfig.h"
#include "sysdeps.h"

#include "options.h"
#include "memory.h"
#include "custom.h"
#include "gensound.h"
#include "sd-sound.h"
#include "events.h"
#include "cia.h"
#include "audio.h"
#include "amigafilter.h"
#include "uade.h"

/* Look at contrib/sinc-integral.py to see how winsinc_integral[] table is
   computed. */
static int winsinc_integral[4096] = {
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     1,     1,     1,     1,
    1,     1,     1,     1,     1,     1,     1,     1,     1,     1,     1,     1,
    1,     2,     2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
    2,     2,     2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
    2,     2,     2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
    1,     1,     1,     1,     1,     1,     1,     1,     1,     1,     1,     0,
    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
    0,     0,    -1,    -1,    -1,    -1,    -1,    -1,    -2,    -2,    -2,    -2,
   -2,    -2,    -2,    -3,    -3,    -3,    -3,    -3,    -3,    -3,    -4,    -4,
   -4,    -4,    -4,    -4,    -4,    -4,    -4,    -5,    -5,    -5,    -5,    -5,
   -5,    -5,    -5,    -5,    -5,    -5,    -5,    -5,    -5,    -5,    -5,    -5,
   -5,    -5,    -5,    -5,    -5,    -5,    -5,    -4,    -4,    -4,    -4,    -4,
   -4,    -4,    -4,    -3,    -3,    -3,    -3,    -3,    -2,    -2,    -2,    -2,
   -1,    -1,    -1,    -1,     0,     0,     0,     0,     0,     0,     0,     0,
    1,     1,     1,     2,     2,     2,     3,     3,     3,     3,     4,     4,
    4,     5,     5,     5,     5,     6,     6,     6,     7,     7,     7,     7,
    8,     8,     8,     8,     8,     9,     9,     9,     9,     9,     9,     9,
   10,    10,    10,    10,    10,    10,    10,    10,    10,    10,    10,    10,
   10,    10,     9,     9,     9,     9,     9,     9,     9,     8,     8,     8,
    8,     7,     7,     7,     6,     6,     6,     5,     5,     5,     4,     4,
    4,     3,     3,     2,     2,     1,     1,     0,     0,     0,     0,    -1,
   -1,    -2,    -2,    -3,    -3,    -4,    -4,    -5,    -5,    -6,    -6,    -7,
   -7,    -8,    -8,    -9,    -9,   -10,   -10,   -11,   -11,   -12,   -12,   -12,
  -13,   -13,   -13,   -14,   -14,   -14,   -15,   -15,   -15,   -16,   -16,   -16,
  -16,   -16,   -16,   -17,   -17,   -17,   -17,   -17,   -17,   -17,   -17,   -16,
  -16,   -16,   -16,   -16,   -16,   -15,   -15,   -15,   -15,   -14,   -14,   -13,
  -13,   -13,   -12,   -12,   -11,   -11,   -10,   -10,    -9,    -8,    -8,    -7,
   -6,    -6,    -5,    -4,    -3,    -3,    -2,    -1,     0,     0,     0,     1,
    2,     3,     3,     4,     5,     6,     7,     8,     8,     9,    10,    11,
   12,    12,    13,    14,    15,    15,    16,    17,    18,    18,    19,    20,
   20,    21,    21,    22,    22,    23,    23,    24,    24,    25,    25,    25,
   26,    26,    26,    26,    26,    26,    26,    26,    26,    26,    26,    26,
   26,    26,    25,    25,    25,    24,    24,    24,    23,    23,    22,    21,
   21,    20,    19,    19,    18,    17,    16,    15,    14,    13,    13,    12,
   10,     9,     8,     7,     6,     5,     4,     3,     1,     0,     0,    -1,
   -2,    -4,    -5,    -6,    -7,    -9,   -10,   -11,   -12,   -14,   -15,   -16,
  -17,   -19,   -20,   -21,   -22,   -23,   -24,   -25,   -26,   -27,   -28,   -29,
  -30,   -31,   -32,   -33,   -34,   -34,   -35,   -36,   -36,   -37,   -37,   -38,
  -38,   -38,   -39,   -39,   -39,   -39,   -39,   -39,   -39,   -39,   -39,   -39,
  -39,   -38,   -38,   -38,   -37,   -37,   -36,   -35,   -35,   -34,   -33,   -32,
  -31,   -30,   -29,   -28,   -27,   -26,   -24,   -23,   -22,   -20,   -19,   -18,
  -16,   -14,   -13,   -11,   -10,    -8,    -6,    -5,    -3,    -1,     0,     1,
    3,     5,     7,     9,    11,    12,    14,    16,    18,    20,    21,    23,
   25,    27,    28,    30,    32,    33,    35,    37,    38,    40,    41,    42,
   44,    45,    46,    47,    48,    50,    51,    51,    52,    53,    54,    55,
   55,    56,    56,    56,    57,    57,    57,    57,    57,    57,    57,    56,
   56,    56,    55,    54,    54,    53,    52,    51,    50,    49,    48,    46,
   45,    44,    42,    41,    39,    37,    36,    34,    32,    30,    28,    26,
   24,    21,    19,    17,    15,    12,    10,     7,     5,     2,     0,    -2,
   -4,    -7,    -9,   -12,   -14,   -17,   -20,   -22,   -25,   -27,   -30,   -32,
  -35,   -37,   -40,   -42,   -44,   -47,   -49,   -51,   -53,   -55,   -57,   -59,
  -61,   -63,   -65,   -66,   -68,   -69,   -71,   -72,   -73,   -74,   -75,   -76,
  -77,   -78,   -78,   -79,   -79,   -80,   -80,   -80,   -80,   -80,   -79,   -79,
  -78,   -78,   -77,   -76,   -75,   -74,   -73,   -72,   -70,   -69,   -67,   -65,
  -63,   -61,   -59,   -57,   -55,   -52,   -50,   -47,   -45,   -42,   -39,   -36,
  -33,   -30,   -27,   -24,   -21,   -18,   -14,   -11,    -8,    -4,    -1,     2,
    5,     9,    12,    16,    20,    23,    27,    30,    34,    37,    41,    44,
   48,    51,    54,    58,    61,    64,    67,    70,    73,    76,    78,    81,
   84,    86,    89,    91,    93,    95,    97,    99,   100,   102,   103,   104,
  106,   107,   107,   108,   109,   109,   109,   109,   109,   109,   109,   108,
  107,   106,   105,   104,   103,   101,   100,    98,    96,    94,    92,    89,
   87,    84,    81,    78,    75,    72,    69,    65,    62,    58,    54,    50,
   46,    42,    38,    34,    29,    25,    20,    16,    11,     7,     2,    -2,
   -7,   -11,   -16,   -21,   -26,   -31,   -35,   -40,   -45,   -50,   -54,   -59,
  -64,   -68,   -73,   -77,   -81,   -85,   -90,   -94,   -98,  -101,  -105,  -109,
 -112,  -115,  -119,  -122,  -125,  -127,  -130,  -132,  -134,  -136,  -138,  -140,
 -141,  -143,  -144,  -145,  -146,  -146,  -146,  -146,  -146,  -146,  -146,  -145,
 -144,  -143,  -141,  -140,  -138,  -136,  -134,  -131,  -129,  -126,  -123,  -120,
 -116,  -113,  -109,  -105,  -101,   -97,   -92,   -88,   -83,   -78,   -73,   -68,
  -62,   -57,   -51,   -46,   -40,   -34,   -28,   -22,   -16,   -10,    -4,     2,
    8,    14,    21,    27,    34,    40,    46,    53,    59,    65,    71,    78,
   84,    90,    96,   101,   107,   113,   118,   124,   129,   134,   139,   143,
  148,   152,   157,   161,   164,   168,   171,   175,   177,   180,   183,   185,
  187,   189,   190,   191,   192,   193,   193,   193,   193,   193,   192,   191,
  190,   188,   187,   185,   182,   180,   177,   174,   170,   166,   162,   158,
  154,   149,   144,   139,   134,   128,   122,   116,   110,   103,    97,    90,
   83,    76,    69,    61,    54,    46,    38,    30,    22,    14,     6,    -1,
  -10,   -18,   -26,   -35,   -43,   -51,   -60,   -68,   -76,   -84,   -93,  -101,
 -109,  -116,  -124,  -132,  -139,  -147,  -154,  -161,  -167,  -174,  -180,  -187,
 -193,  -198,  -204,  -209,  -214,  -219,  -223,  -227,  -231,  -234,  -238,  -241,
 -243,  -245,  -247,  -249,  -250,  -251,  -251,  -252,  -251,  -251,  -250,  -249,
 -247,  -245,  -243,  -240,  -237,  -234,  -230,  -226,  -221,  -217,  -212,  -206,
 -200,  -194,  -188,  -181,  -174,  -167,  -159,  -151,  -143,  -135,  -126,  -118,
 -108,   -99,   -90,   -80,   -70,   -60,   -50,   -40,   -30,   -19,    -9,     1,
   12,    23,    33,    44,    55,    66,    77,    87,    98,   108,   119,   129,
  140,   150,   160,   170,   179,   189,   198,   207,   216,   224,   232,   240,
  248,   255,   263,   269,   276,   282,   287,   293,   298,   302,   306,   310,
  313,   316,   319,   321,   322,   323,   324,   324,   324,   323,   322,   321,
  318,   316,   313,   309,   306,   301,   296,   291,   285,   279,   273,   266,
  258,   250,   242,   234,   225,   215,   206,   195,   185,   174,   163,   152,
  140,   128,   116,   104,    91,    79,    66,    52,    39,    26,    12,    -1,
  -14,   -28,   -42,   -56,   -70,   -83,   -97,  -111,  -125,  -138,  -152,  -165,
 -178,  -191,  -204,  -216,  -229,  -241,  -253,  -264,  -275,  -286,  -297,  -307,
 -317,  -326,  -335,  -344,  -352,  -360,  -367,  -374,  -380,  -386,  -391,  -396,
 -400,  -404,  -407,  -410,  -412,  -413,  -414,  -414,  -414,  -413,  -412,  -410,
 -407,  -404,  -400,  -395,  -390,  -385,  -379,  -372,  -365,  -357,  -349,  -340,
 -330,  -320,  -310,  -299,  -287,  -275,  -263,  -250,  -237,  -223,  -209,  -194,
 -180,  -164,  -149,  -133,  -117,  -101,   -84,   -67,   -51,   -33,   -16,     0,
   18,    35,    53,    71,    88,   106,   123,   141,   158,   176,   193,   210,
  226,   243,   259,   275,   291,   306,   321,   336,   350,   364,   378,   391,
  403,   415,   427,   438,   448,   458,   467,   476,   484,   491,   498,   504,
  509,   514,   518,   521,   524,   526,   527,   527,   527,   526,   524,   521,
  518,   514,   509,   503,   497,   490,   482,   473,   464,   454,   443,   432,
  420,   407,   394,   380,   365,   350,   334,   318,   301,   284,   266,   248,
  229,   209,   190,   170,   149,   129,   107,    86,    65,    43,    21,     0,
  -23,   -45,   -67,   -90,  -112,  -135,  -157,  -179,  -201,  -223,  -245,  -267,
 -288,  -309,  -330,  -350,  -370,  -389,  -409,  -427,  -445,  -463,  -480,  -497,
 -513,  -528,  -542,  -556,  -570,  -582,  -594,  -605,  -615,  -624,  -633,  -641,
 -647,  -653,  -658,  -663,  -666,  -668,  -670,  -670,  -670,  -668,  -666,  -663,
 -658,  -653,  -647,  -640,  -632,  -623,  -613,  -602,  -590,  -577,  -564,  -549,
 -534,  -518,  -501,  -483,  -464,  -445,  -425,  -404,  -383,  -360,  -338,  -314,
 -290,  -266,  -241,  -215,  -189,  -163,  -136,  -109,   -81,   -54,   -26,     2,
   30,    58,    87,   116,   144,   173,   201,   230,   258,   286,   314,   341,
  368,   395,   421,   447,   473,   498,   522,   546,   569,   592,   614,   635,
  655,   674,   693,   711,   728,   744,   759,   773,   786,   798,   809,   818,
  827,   835,   841,   847,   851,   854,   856,   856,   856,   854,   851,   846,
  841,   834,   826,   817,   807,   795,   783,   769,   753,   737,   720,   701,
  682,   661,   639,   616,   593,   568,   542,   515,   488,   459,   430,   400,
  369,   338,   306,   273,   239,   206,   171,   136,   101,    65,    29,    -6,
  -42,   -79,  -116,  -152,  -189,  -226,  -262,  -299,  -335,  -371,  -407,  -442,
 -477,  -512,  -546,  -579,  -612,  -644,  -676,  -707,  -736,  -765,  -794,  -821,
 -847,  -872,  -896,  -919,  -941,  -962,  -981,  -999, -1016, -1031, -1045, -1058,
-1070, -1079, -1088, -1095, -1100, -1104, -1106, -1107, -1106, -1104, -1100, -1094,
-1087, -1079, -1068, -1057, -1043, -1028, -1012,  -993,  -974,  -953,  -930,  -906,
 -880,  -853,  -825,  -795,  -764,  -732,  -699,  -664,  -628,  -591,  -553,  -514,
 -473,  -432,  -390,  -347,  -304,  -259,  -214,  -169,  -123,   -76,   -29,    17,
   65,   113,   161,   209,   257,   306,   354,   402,   449,   497,   544,   590,
  636,   681,   726,   770,   813,   856,   897,   938,   977,  1015,  1053,  1088,
 1123,  1156,  1188,  1218,  1247,  1274,  1300,  1324,  1346,  1367,  1386,  1402,
 1417,  1430,  1442,  1451,  1458,  1463,  1466,  1467,  1466,  1463,  1458,  1450,
 1441,  1429,  1416,  1400,  1382,  1362,  1340,  1316,  1289,  1261,  1231,  1198,
 1164,  1128,  1090,  1050,  1009,   965,   920,   873,   825,   775,   724,   671,
  617,   561,   505,   447,   388,   328,   267,   205,   143,    80,    16,   -48,
 -112,  -177,  -243,  -308,  -374,  -440,  -505,  -570,  -635,  -700,  -764,  -828,
 -890,  -953, -1014, -1074, -1133, -1192, -1248, -1304, -1358, -1411, -1462, -1511,
-1559, -1605, -1649, -1691, -1731, -1768, -1804, -1837, -1868, -1896, -1922, -1946,
-1966, -1985, -2000, -2013, -2023, -2030, -2035, -2036, -2035, -2030, -2023, -2012,
-1999, -1983, -1964, -1941, -1916, -1888, -1856, -1822, -1785, -1745, -1702, -1656,
-1608, -1556, -1502, -1446, -1386, -1324, -1260, -1193, -1124, -1053,  -979,  -903,
 -825,  -745,  -664,  -580,  -495,  -409,  -321,  -231,  -141,   -49,    43,   136,
  230,   325,   421,   517,   613,   709,   805,   901,   996,  1091,  1186,  1280,
 1373,  1465,  1555,  1645,  1733,  1819,  1904,  1987,  2068,  2147,  2224,  2298,
 2369,  2438,  2505,  2568,  2628,  2685,  2739,  2790,  2836,  2880,  2920,  2955,
 2987,  3015,  3039,  3059,  3074,  3085,  3092,  3094,  3092,  3085,  3074,  3058,
 3037,  3011,  2981,  2946,  2906,  2861,  2812,  2757,  2698,  2635,  2566,  2493,
 2415,  2332,  2245,  2153,  2057,  1957,  1852,  1743,  1630,  1513,  1392,  1267,
 1139,  1007,   872,   733,   591,   446,   299,   149,    -3,  -158,  -315,  -474,
 -635,  -797,  -961, -1126, -1292, -1458, -1625, -1792, -1959, -2126, -2292, -2458,
-2623, -2786, -2948, -3109, -3267, -3423, -3577, -3727, -3875, -4020, -4160, -4297,
-4430, -4559, -4683, -4802, -4915, -5024, -5126, -5223, -5313, -5397, -5474, -5544,
-5606, -5661, -5708, -5748, -5778, -5801, -5814, -5819, -5814, -5800, -5776, -5743,
-5699, -5645, -5581, -5506, -5420, -5323, -5215, -5095, -4965, -4822, -4668, -4502,
-4324, -4134, -3931, -3717, -3490, -3250, -2998, -2733, -2456, -2166, -1864, -1549,
-1221,  -880,  -526,  -160,   217,   609,  1013,  1429,  1858,  2300,  2753,  3219,
 3697,  4187,  4689,  5202,  5727,  6264,  6811,  7370,  7940,  8520,  9111,  9712,
10323, 10944, 11575, 12215, 12864, 13523, 14189, 14864, 15548, 16239, 16937, 17643,
18355, 19074, 19800, 20531, 21268, 22011, 22758, 23510, 24266, 25026, 25790, 26557,
27327, 28100, 28874, 29651, 30429, 31208, 31987, 32768, 33548, 34327, 35106, 35884,
36661, 37436, 38208, 38978, 39745, 40509, 41269, 42025, 42777, 43524, 44267, 45004,
45735, 46461, 47180, 47892, 48598, 49296, 49987, 50671, 51346, 52012, 52671, 53320,
53960, 54591, 55212, 55823, 56424, 57015, 57595, 58165, 58724, 59271, 59808, 60333,
60846, 61348, 61838, 62316, 62782, 63235, 63677, 64106, 64522, 64926, 65318, 65696,
66063, 66416, 66757, 67085, 67400, 67702, 67992, 68270, 68534, 68786, 69026, 69253,
69467, 69670, 69860, 70038, 70204, 70358, 70501, 70631, 70751, 70859, 70956, 71042,
71117, 71181, 71235, 71279, 71312, 71336, 71350, 71355, 71350, 71337, 71315, 71284,
71244, 71197, 71142, 71080, 71010, 70933, 70849, 70759, 70662, 70560, 70451, 70338,
70219, 70095, 69966, 69834, 69696, 69556, 69411, 69263, 69113, 68959, 68803, 68645,
68484, 68322, 68159, 67994, 67828, 67662, 67495, 67328, 67161, 66994, 66828, 66662,
66497, 66334, 66171, 66010, 65851, 65694, 65539, 65387, 65236, 65089, 64944, 64802,
64663, 64528, 64396, 64268, 64143, 64022, 63905, 63792, 63683, 63578, 63478, 63382,
63290, 63203, 63120, 63042, 62969, 62901, 62837, 62778, 62723, 62674, 62629, 62589,
62554, 62524, 62498, 62478, 62461, 62450, 62443, 62441, 62443, 62450, 62461, 62476,
62496, 62520, 62548, 62580, 62616, 62655, 62699, 62746, 62796, 62850, 62907, 62967,
63031, 63097, 63166, 63237, 63312, 63388, 63467, 63548, 63631, 63716, 63802, 63890,
63980, 64071, 64162, 64255, 64349, 64444, 64539, 64634, 64730, 64826, 64923, 65019,
65114, 65210, 65305, 65399, 65492, 65585, 65677, 65767, 65857, 65945, 66031, 66116,
66200, 66282, 66361, 66439, 66515, 66589, 66660, 66729, 66796, 66860, 66922, 66982,
67038, 67093, 67144, 67192, 67238, 67281, 67321, 67358, 67393, 67424, 67452, 67477,
67500, 67519, 67535, 67549, 67559, 67566, 67571, 67572, 67571, 67566, 67559, 67549,
67536, 67521, 67503, 67482, 67458, 67432, 67404, 67373, 67340, 67304, 67267, 67227,
67185, 67141, 67095, 67047, 66998, 66947, 66894, 66840, 66784, 66728, 66669, 66610,
66550, 66489, 66427, 66364, 66300, 66236, 66171, 66106, 66041, 65976, 65910, 65844,
65779, 65713, 65648, 65584, 65519, 65456, 65392, 65330, 65268, 65207, 65147, 65088,
65031, 64974, 64918, 64864, 64811, 64760, 64710, 64662, 64615, 64570, 64527, 64485,
64445, 64407, 64371, 64337, 64304, 64274, 64246, 64220, 64195, 64173, 64153, 64135,
64119, 64106, 64094, 64085, 64077, 64072, 64069, 64068, 64069, 64072, 64077, 64084,
64093, 64105, 64118, 64133, 64150, 64168, 64189, 64211, 64235, 64261, 64288, 64317,
64347, 64379, 64412, 64447, 64483, 64520, 64558, 64597, 64638, 64679, 64722, 64765,
64809, 64854, 64899, 64945, 64991, 65038, 65086, 65133, 65181, 65229, 65278, 65326,
65374, 65422, 65470, 65518, 65565, 65612, 65659, 65705, 65751, 65796, 65840, 65883,
65926, 65968, 66009, 66050, 66089, 66127, 66164, 66200, 66235, 66268, 66301, 66332,
66361, 66390, 66416, 66442, 66466, 66489, 66510, 66529, 66548, 66564, 66579, 66593,
66604, 66615, 66623, 66631, 66636, 66640, 66642, 66643, 66642, 66640, 66636, 66631,
66624, 66615, 66606, 66594, 66582, 66567, 66552, 66535, 66517, 66498, 66477, 66455,
66432, 66408, 66383, 66357, 66330, 66302, 66273, 66243, 66212, 66180, 66148, 66115,
66082, 66048, 66013, 65978, 65943, 65907, 65871, 65835, 65799, 65762, 65725, 65688,
65652, 65615, 65578, 65542, 65506, 65470, 65434, 65399, 65364, 65330, 65296, 65262,
65229, 65197, 65166, 65135, 65105, 65076, 65047, 65020, 64993, 64967, 64942, 64919,
64896, 64874, 64853, 64834, 64815, 64798, 64782, 64766, 64753, 64740, 64728, 64718,
64709, 64701, 64694, 64689, 64684, 64681, 64680, 64679, 64680, 64681, 64684, 64689,
64694, 64700, 64708, 64717, 64727, 64737, 64749, 64762, 64776, 64791, 64807, 64824,
64842, 64861, 64880, 64900, 64922, 64943, 64966, 64989, 65013, 65037, 65062, 65088,
65114, 65140, 65167, 65194, 65222, 65249, 65277, 65306, 65334, 65362, 65391, 65420,
65448, 65477, 65505, 65533, 65562, 65590, 65617, 65645, 65672, 65699, 65725, 65751,
65777, 65802, 65826, 65850, 65874, 65897, 65919, 65940, 65961, 65981, 66000, 66019,
66037, 66054, 66070, 66085, 66100, 66113, 66126, 66138, 66149, 66159, 66168, 66176,
66183, 66189, 66194, 66199, 66202, 66204, 66206, 66206, 66206, 66204, 66202, 66199,
66195, 66189, 66184, 66177, 66169, 66160, 66151, 66141, 66130, 66118, 66106, 66092,
66079, 66064, 66049, 66033, 66016, 65999, 65982, 65963, 65945, 65926, 65906, 65886,
65866, 65845, 65824, 65803, 65781, 65759, 65737, 65715, 65693, 65671, 65648, 65626,
65603, 65581, 65559, 65536, 65514, 65492, 65470, 65449, 65428, 65407, 65386, 65365,
65345, 65326, 65306, 65288, 65269, 65251, 65234, 65217, 65201, 65185, 65170, 65155,
65141, 65128, 65115, 65103, 65092, 65081, 65071, 65062, 65053, 65045, 65038, 65032,
65026, 65021, 65017, 65014, 65011, 65009, 65008, 65008, 65008, 65009, 65011, 65014,
65017, 65021, 65026, 65031, 65037, 65044, 65051, 65059, 65068, 65077, 65087, 65097,
65108, 65120, 65132, 65144, 65157, 65171, 65185, 65199, 65214, 65229, 65244, 65260,
65276, 65292, 65309, 65325, 65342, 65359, 65377, 65394, 65412, 65429, 65447, 65464,
65482, 65500, 65517, 65535, 65552, 65569, 65587, 65604, 65620, 65637, 65653, 65669,
65685, 65701, 65716, 65730, 65745, 65759, 65773, 65786, 65799, 65811, 65823, 65835,
65846, 65856, 65866, 65876, 65885, 65893, 65901, 65908, 65915, 65921, 65927, 65932,
65936, 65940, 65943, 65946, 65948, 65949, 65950, 65950, 65950, 65949, 65948, 65946,
65943, 65940, 65936, 65932, 65927, 65922, 65916, 65910, 65903, 65896, 65888, 65880,
65871, 65862, 65853, 65843, 65833, 65822, 65812, 65800, 65789, 65777, 65765, 65753,
65740, 65727, 65714, 65701, 65688, 65674, 65661, 65647, 65633, 65620, 65606, 65592,
65578, 65564, 65550, 65537, 65523, 65509, 65496, 65483, 65470, 65457, 65444, 65431,
65419, 65407, 65395, 65383, 65372, 65361, 65350, 65340, 65330, 65320, 65310, 65301,
65293, 65285, 65277, 65269, 65262, 65256, 65250, 65244, 65239, 65234, 65229, 65226,
65222, 65219, 65217, 65215, 65213, 65212, 65211, 65211, 65211, 65212, 65213, 65214,
65216, 65219, 65222, 65225, 65229, 65233, 65237, 65242, 65248, 65253, 65259, 65266,
65273, 65280, 65287, 65295, 65303, 65311, 65319, 65328, 65337, 65346, 65356, 65365,
65375, 65385, 65395, 65406, 65416, 65427, 65437, 65448, 65459, 65469, 65480, 65491,
65502, 65512, 65523, 65534, 65545, 65555, 65566, 65576, 65586, 65596, 65606, 65616,
65626, 65635, 65645, 65654, 65662, 65671, 65679, 65688, 65695, 65703, 65710, 65717,
65724, 65730, 65736, 65742, 65748, 65753, 65758, 65762, 65766, 65770, 65773, 65776,
65779, 65781, 65783, 65785, 65786, 65787, 65788, 65788, 65788, 65787, 65786, 65785,
65783, 65781, 65779, 65777, 65774, 65771, 65767, 65763, 65759, 65755, 65750, 65745,
65740, 65734, 65729, 65723, 65717, 65710, 65704, 65697, 65690, 65683, 65675, 65668,
65660, 65653, 65645, 65637, 65629, 65621, 65612, 65604, 65596, 65587, 65579, 65571,
65562, 65554, 65546, 65537, 65529, 65521, 65513, 65505, 65497, 65489, 65482, 65474,
65467, 65459, 65452, 65445, 65438, 65432, 65425, 65419, 65413, 65407, 65401, 65396,
65391, 65386, 65381, 65377, 65373, 65369, 65365, 65362, 65358, 65355, 65353, 65351,
65348, 65347, 65345, 65344, 65343, 65342, 65342, 65342, 65342, 65342, 65343, 65344,
65345, 65347, 65348, 65350, 65352, 65355, 65358, 65361, 65364, 65367, 65371, 65374,
65378, 65383, 65387, 65392, 65396, 65401, 65406, 65412, 65417, 65422, 65428, 65434,
65439, 65445, 65451, 65457, 65464, 65470, 65476, 65482, 65489, 65495, 65502, 65508,
65514, 65521, 65527, 65533, 65540, 65546, 65552, 65558, 65564, 65570, 65576, 65582,
65587, 65593, 65599, 65604, 65609, 65614, 65619, 65624, 65628, 65633, 65637, 65641,
65645, 65649, 65652, 65656, 65659, 65662, 65665, 65667, 65670, 65672, 65674, 65676,
65677, 65679, 65680, 65681, 65682, 65682, 65682, 65683, 65682, 65682, 65682, 65681,
65680, 65679, 65678, 65676, 65674, 65673, 65670, 65668, 65666, 65663, 65661, 65658,
65655, 65652, 65648, 65645, 65641, 65637, 65634, 65630, 65626, 65622, 65617, 65613,
65609, 65604, 65600, 65595, 65590, 65586, 65581, 65576, 65571, 65567, 65562, 65557,
65552, 65547, 65543, 65538, 65533, 65528, 65524, 65519, 65515, 65510, 65506, 65501,
65497, 65493, 65489, 65485, 65481, 65477, 65473, 65470, 65466, 65463, 65460, 65457,
65454, 65451, 65448, 65446, 65443, 65441, 65439, 65437, 65435, 65434, 65432, 65431,
65430, 65429, 65428, 65427, 65427, 65426, 65426, 65426, 65426, 65426, 65427, 65427,
65428, 65429, 65430, 65431, 65432, 65433, 65435, 65436, 65438, 65440, 65442, 65444,
65447, 65449, 65451, 65454, 65457, 65459, 65462, 65465, 65468, 65471, 65474, 65478,
65481, 65484, 65487, 65491, 65494, 65498, 65501, 65505, 65508, 65512, 65516, 65519,
65523, 65526, 65530, 65533, 65537, 65540, 65544, 65547, 65550, 65554, 65557, 65560,
65563, 65566, 65569, 65572, 65575, 65578, 65581, 65583, 65586, 65588, 65591, 65593,
65595, 65597, 65599, 65601, 65603, 65605, 65606, 65608, 65609, 65610, 65611, 65612,
65613, 65614, 65614, 65615, 65615, 65616, 65616, 65616, 65616, 65616, 65615, 65615,
65614, 65614, 65613, 65612, 65611, 65610, 65609, 65608, 65607, 65605, 65604, 65602,
65601, 65599, 65597, 65595, 65593, 65591, 65589, 65587, 65585, 65583, 65580, 65578,
65576, 65573, 65571, 65568, 65566, 65563, 65561, 65558, 65556, 65553, 65551, 65548,
65545, 65543, 65540, 65538, 65535, 65533, 65530, 65528, 65525, 65523, 65520, 65518,
65516, 65514, 65511, 65509, 65507, 65505, 65503, 65501, 65500, 65498, 65496, 65494,
65493, 65491, 65490, 65489, 65487, 65486, 65485, 65484, 65483, 65482, 65481, 65481,
65480, 65480, 65479, 65479, 65478, 65478, 65478, 65478, 65478, 65478, 65478, 65479,
65479, 65479, 65480, 65481, 65481, 65482, 65483, 65484, 65485, 65486, 65487, 65488,
65489, 65490, 65491, 65493, 65494, 65496, 65497, 65499, 65500, 65502, 65503, 65505,
65507, 65508, 65510, 65512, 65514, 65515, 65517, 65519, 65521, 65523, 65524, 65526,
65528, 65530, 65532, 65534, 65535, 65537, 65539, 65541, 65542, 65544, 65546, 65547,
65549, 65551, 65552, 65554, 65555, 65556, 65558, 65559, 65560, 65562, 65563, 65564,
65565, 65566, 65567, 65568, 65569, 65570, 65571, 65571, 65572, 65573, 65573, 65574,
65574, 65575, 65575, 65575, 65575, 65575, 65576, 65576, 65576, 65575, 65575, 65575,
65575, 65575, 65574, 65574, 65573, 65573, 65572, 65572, 65571, 65570, 65570, 65569,
65568, 65567, 65566, 65565, 65564, 65563, 65562, 65561, 65560, 65559, 65558, 65557,
65556, 65555, 65553, 65552, 65551, 65550, 65548, 65547, 65546, 65545, 65543, 65542,
65541, 65540, 65538, 65537, 65536, 65535, 65534, 65532, 65531, 65530, 65529, 65528,
65527, 65526, 65525, 65524, 65523, 65522, 65521, 65520, 65519, 65518, 65517, 65516,
65516, 65515, 65514, 65514, 65513, 65512, 65512, 65511, 65511, 65511, 65510, 65510,
65510, 65509, 65509, 65509, 65509, 65509, 65509, 65509, 65509, 65509, 65509, 65509,
65509, 65509, 65510, 65510, 65510, 65510, 65511, 65511, 65512, 65512, 65513, 65513,
65514, 65514, 65515, 65515, 65516, 65517, 65517, 65518, 65519, 65520, 65520, 65521,
65522, 65523, 65523, 65524, 65525, 65526, 65527, 65528, 65528, 65529, 65530, 65531,
65532, 65532, 65533, 65534, 65535, 65536, 65537, 65537, 65538, 65539, 65540, 65540,
65541, 65542, 65542, 65543, 65544, 65544, 65545, 65546, 65546, 65547, 65547, 65548,
65548, 65549, 65549, 65550, 65550, 65550, 65551, 65551, 65551, 65552, 65552, 65552,
65552, 65552, 65552, 65553, 65553, 65553, 65553, 65553, 65553, 65553, 65553, 65553,
65552, 65552, 65552, 65552, 65552, 65552, 65551, 65551, 65551, 65551, 65550, 65550,
65550, 65549, 65549, 65548, 65548, 65548, 65547, 65547, 65546, 65546, 65545, 65545,
65544, 65544, 65543, 65543, 65542, 65542, 65541, 65541, 65540, 65540, 65539, 65539,
65538, 65538, 65537, 65537, 65536, 65536, 65535, 65535, 65534, 65534, 65533, 65533,
65532, 65532, 65532, 65531, 65531, 65530, 65530, 65530, 65529, 65529, 65529, 65528,
65528, 65528, 65527, 65527, 65527, 65527, 65526, 65526, 65526, 65526, 65526, 65526,
65526, 65525, 65525, 65525, 65525, 65525, 65525, 65525, 65525, 65525, 65525, 65525,
65525, 65525, 65526, 65526, 65526, 65526, 65526, 65526, 65526, 65527, 65527, 65527,
65527, 65527, 65528, 65528, 65528, 65528, 65529, 65529, 65529, 65529, 65530, 65530,
65530, 65530, 65531, 65531, 65531, 65532, 65532, 65532, 65533, 65533, 65533, 65533,
65534, 65534, 65534, 65535, 65535, 65535, 65535, 65536, 65536, 65536, 65537, 65537,
65537, 65537, 65538, 65538, 65538, 65538, 65538, 65539, 65539, 65539, 65539, 65539,
65540, 65540, 65540, 65540, 65540, 65540, 65540, 65541, 65541, 65541, 65541, 65541,
65541, 65541, 65541, 65541, 65541, 65541, 65541, 65541, 65541, 65541, 65541, 65541,
65541, 65541, 65541, 65541, 65541, 65541, 65541, 65541, 65541, 65540, 65540, 65540,
65540, 65540, 65540, 65540, 65540, 65539, 65539, 65539, 65539, 65539, 65539, 65539,
65538, 65538, 65538, 65538, 65538, 65538, 65538, 65537, 65537, 65537, 65537, 65537,
65537, 65537, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65535, 65535, 65535,
65535, 65535, 65535, 65535, 65535, 65534, 65534, 65534, 65534, 65534, 65534, 65534,
65534, 65534, 65534, 65534, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533,
65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533,
65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533, 65533,
65533, 65534, 65534, 65534, 65534, 65534, 65534, 65534, 65534, 65534, 65534, 65534,
65534, 65534, 65534, 65534, 65534, 65534, 65535, 65535, 65535, 65535, 65535, 65535,
65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536,
65536, 65536, 65536, 65536
};

struct audio_channel_data audio_channel[4];
void (*sample_handler) (void);
static void (*sample_prehandler) (unsigned long best_evtime);

/* Average time in bus cycles to output a new sample */
float sample_evtime_interval;
static float next_sample_evtime;

int sound_available;

int sound_use_filter = FILTER_MODEL_A500E;

static unsigned long last_audio_cycles;

static int audperhack;

static struct filter_state {
    float rc1, rc2, rc3, rc4, rc5;
} sound_filter_state[2];

/* Amiga has two separate filtering circuits per channel, a static RC filter
 * on A500 and the LED filter. This code emulates both.
 * 
 * The Amiga filtering circuitry depends on Amiga model. Older Amigas seem
 * to have a 6 dB/oct RC filter with cutoff frequency such that the -6 dB
 * point for filter is reached at 6 kHz, while newer Amigas have no filtering.
 *
 * The LED filter is complicated, and we are modelling it with a pair of
 * RC filters, the other providing a highboost. The LED starts to cut
 * into signal somewhere around 5-6 kHz, and there's some kind of highboost
 * in effect above 12 kHz. Better measurements are required.
 *
 * The current filtering should be accurate to 2 dB with the filter on,
 * and to 1 dB with the filter off.
*/

static int filter(int input, struct filter_state *fs)
{
    int o;
    float tmp, normal_output, led_output;

    /* white noise generator for filter debugging
    data = 65535 * (drand48() - 0.5);
    */
    switch (sound_use_filter) {
        
    case FILTER_MODEL_A500: 
	tmp  = 0.36 * input;
	tmp += 0.64 * fs->rc1;
	fs->rc1 = tmp;
        normal_output = fs->rc1;
    
        /* lowpass */
        tmp  = 0.33 * normal_output;
        tmp += 0.67 * fs->rc2;
        fs->rc2 = tmp;

        /* highboost */
        tmp  = 1.35 * fs->rc2;
        tmp -= 0.35 * fs->rc3;
        fs->rc3 = tmp;
        led_output = fs->rc3 * 0.98;
        break;
        
    case FILTER_MODEL_A1200:
        normal_output = input;
        
        /* lowpass */
        tmp  = 0.33 * normal_output;
        tmp += 0.67 * fs->rc2;
        fs->rc2 = tmp;

        /* highboost */
        tmp  = 1.35 * fs->rc2;
        tmp -= 0.35 * fs->rc3;
        fs->rc3 = tmp;
        led_output = fs->rc3 * 0.98;
        break;

    case FILTER_MODEL_A500E:
	fs->rc1 = 0.52 * input   + 0.48 * fs->rc1;
	fs->rc2 = 0.92 * fs->rc1 + 0.08 * fs->rc2;
	normal_output = fs->rc2;

	fs->rc3 = 0.48 * normal_output + 0.52 * fs->rc3;
	fs->rc4 = 0.48 * fs->rc3       + 0.52 * fs->rc4;
	fs->rc5 = 0.48 * fs->rc4       + 0.52 * fs->rc5;

	led_output = fs->rc5;
        break;
        
    case FILTER_MODEL_A1200E:
        normal_output = input;

        fs->rc2 = 0.48 * normal_output + 0.52 * fs->rc2;
        fs->rc3 = 0.48 * fs->rc2       + 0.52 * fs->rc3;
        fs->rc4 = 0.48 * fs->rc3       + 0.52 * fs->rc4;

        led_output = fs->rc4;
        break;

    default:
	fprintf(stderr, "Unknown filter mode\n");
	exit(-1);
    }

    o = gui_ledstate ? led_output : normal_output;

    if (o > 32767) {
	o = 32767;
    } else if (o < -32768) {
	o = -32768;
    }

    return o;
}


static void check_sound_buffers (void)
{
    if (uade_reboot)
	return;
    assert(uade_read_size > 0);
    intptr_t bytes = ((intptr_t) sndbufpt) - ((intptr_t) sndbuffer);
    if (uade_audio_output) {
	if (bytes == uade_read_size) {
	    uade_check_sound_buffers(uade_read_size);
	    sndbufpt = sndbuffer;
	}
    } else {
	uade_audio_skip += bytes;
	/* if sound core doesn't report audio output start in 3 seconds from
	   the reboot, begin audio output anyway */
	if (uade_audio_skip >= (sound_bytes_per_second * 3)) {
	    fprintf(stderr, "involuntary audio output start\n");
	    uade_audio_output = 1;
	}
	sndbufpt = sndbuffer;
    }
}


static inline void sample_backend(int left, int right)
{
#if AUDIO_DEBUG
    int nr;
    for (nr = 0; nr < 4; nr++) {
	struct audio_channel_data *cdp = audio_channel + nr;
	if (cdp->state != 0 && cdp->datpt != 0 && (dmacon & (1 << nr)) && cdp->datpt >= cdp->datptend) {
	    fprintf(stderr, "Audio output overrun on channel %d: %.8x/%.8x\n", nr, cdp->datpt, cdp->datptend);
	}
    }
#endif

    /* samples are in range -16384 (-128*64*2) and 16256 (127*64*2) */
    left <<= 16 - 14 - 1;
    right <<= 16 - 14 - 1;
    /* [-32768, 32512] */

    if (sound_use_filter) {
	left = filter(left, &sound_filter_state[0]);
	right = filter(right, &sound_filter_state[1]);
    }

    *(sndbufpt++) = left;
    *(sndbufpt++) = right;

    check_sound_buffers();
}


void sample16s_handler (void)
{
    int datas[4];
    int i;

    for (i = 0; i < 4; i++) {
	datas[i] = audio_channel[i].current_sample * audio_channel[i].vol;
	datas[i] &= audio_channel[i].adk_mask;
    }

    sample_backend(datas[0] + datas[3], datas[1] + datas[2]);
}


/* This interpolator examines sample points when Paula switches the output
 * voltage and computes the average of Paula's output */
static void sample16si_anti_handler (void)
{
    int i;
    int datas[4];

    for (i = 0; i < 4; i += 1) {
        datas[i] = audio_channel[i].sample_accum / audio_channel[i].sample_accum_time;
        audio_channel[i].sample_accum = 0;
	audio_channel[i].sample_accum_time = 0;
    }

    sample_backend(datas[0] + datas[3], datas[1] + datas[2]);
}

static void sample16si_sinc_handler (void)
{
    int i;
    int datas[4];
    
    for (i = 0; i < 4; i += 1) {
        int j, pos=0, sum=0;
        struct audio_channel_data *acd = &audio_channel[i];

        /* this computes the sinc convolution for the stored samples in buffer */ 
        for (j = 0; j < acd->sinc_queue_length; j += 1) {
            int newpos = acd->sinc_queue[j].age;
            int output = acd->sinc_queue[j].output;
            if (newpos > SINC_QUEUE_MAX_AGE-1)
                newpos = SINC_QUEUE_MAX_AGE-1;
            sum += (winsinc_integral[newpos] - winsinc_integral[pos]) * output;
            pos = newpos;
        }
        datas[i] = sum >> 16;
    }

    sample_backend(datas[0] + datas[3], datas[1] + datas[2]);
}


static void anti_sinc_prehandler(unsigned long best_evtime)
{
    int i, j, output;
    struct audio_channel_data *acd;

    /* Handle accumulator antialiasiation */
    for (i = 0; i < 4; i++) {
	acd = &audio_channel[i];
	output = (acd->current_sample * acd->vol) & acd->adk_mask;
	acd->sample_accum += output * best_evtime;
	acd->sample_accum_time += best_evtime;

	if (sample_handler == sample16si_sinc_handler) {

	    /* age the sinc queue and truncate it when necessary */
	    for (j = 0; j < SINC_QUEUE_LENGTH; j += 1) {
		if (acd->sinc_queue[j].age >= SINC_QUEUE_MAX_AGE) {
		    acd->sinc_queue_length = j+1;
		    break;
		}
		acd->sinc_queue[j].age += best_evtime;
	    }
	    /* if the output state changes, put the new state into the pipeline */
	    if (acd->sinc_queue[0].output != output) {
		acd->sinc_queue_length += 1;
		if (acd->sinc_queue_length > SINC_QUEUE_LENGTH) {
		    fprintf(stderr, "warning, sinc queue truncated. Last age: %d.\n", acd->sinc_queue[SINC_QUEUE_LENGTH-1].age);
		    acd->sinc_queue_length = SINC_QUEUE_LENGTH;
		}
		/* make room for new and add the new value */
		for (j = acd->sinc_queue_length-1; j > 0; j -= 1) {
		    acd->sinc_queue[j] = acd->sinc_queue[j-1];
		}
		acd->sinc_queue[0].age = best_evtime;
		acd->sinc_queue[0].output = output;
	    }
	}
    }
}


static void audio_handler (int nr)
{
    struct audio_channel_data *cdp = audio_channel + nr;

    switch (cdp->state) {
     case 0:
	fprintf(stderr, "Bug in sound code\n");
	break;

     case 1:
	/* We come here at the first hsync after DMA was turned on. */
	cdp->evtime = maxhpos;

	cdp->state = 5;
	INTREQ(0x8000 | (0x80 << nr));
	if (cdp->wlen != 1)
	    cdp->wlen = (cdp->wlen - 1) & 0xFFFF;
	cdp->nextdat = chipmem_bank.wget(cdp->pt);

	cdp->nextdatpt = cdp->pt;
	cdp->nextdatptend = cdp->ptend;

	/* BUG in UAE. Only hsync handler should increase DMA pointer
	   cdp->pt += 2;
	*/
	break;

     case 5:
	/* We come here at the second hsync after DMA was turned on. */
	cdp->evtime = cdp->per;
	cdp->dat = cdp->nextdat;

	cdp->datpt = cdp->nextdatpt;
	cdp->datptend = cdp->nextdatptend;

	cdp->current_sample = (uae_s8)(cdp->dat >> 8);

	cdp->state = 2;
	{
	    int audav = adkcon & (1 << nr);
	    int audap = adkcon & (16 << nr);
	    int napnav = (!audav && !audap) || audav;
	    if (napnav)
		cdp->data_written = 2;
	}
	break;

     case 2:
	/* We come here when a 2->3 transition occurs */
	cdp->current_sample = (uae_s8)(cdp->dat & 0xFF);
	cdp->evtime = cdp->per;

	cdp->state = 3;

	/* Period attachment? */
	if (adkcon & (0x10 << nr)) {
	    if (cdp->intreq2 && cdp->dmaen) {
		INTREQ(0x8000 | (0x80 << nr));
	    }
	    cdp->intreq2 = 0;

	    cdp->dat = cdp->nextdat;

	    cdp->datpt = cdp->nextdatpt;
	    cdp->datptend = cdp->nextdatptend;

	    if (cdp->dmaen)
		cdp->data_written = 2;
	    if (nr < 3) {
		if (cdp->dat == 0)
		    (cdp+1)->per = 65535;
		else
		    (cdp+1)->per = cdp->dat;
	    }
	}
	break;

     case 3:
	/* We come here when a 3->2 transition occurs */
	cdp->evtime = cdp->per;

	if ((INTREQR() & (0x80 << nr)) && !cdp->dmaen) {
	    cdp->state = 0;
	    cdp->current_sample = 0;
	    break;
	} else {
	    int audav = adkcon & (1 << nr);
	    int audap = adkcon & (16 << nr);
	    int napnav = (!audav && !audap) || audav;
	    cdp->state = 2;

	    if ((cdp->intreq2 && cdp->dmaen && napnav)
		|| (napnav && !cdp->dmaen)) {
	      INTREQ(0x8000 | (0x80 << nr));
	    }
	    cdp->intreq2 = 0;

	    cdp->dat = cdp->nextdat;

	    cdp->datpt = cdp->nextdatpt;
	    cdp->datptend = cdp->nextdatptend;

	    cdp->current_sample = (uae_s8)(cdp->dat >> 8);

	    if (cdp->dmaen && napnav)
		cdp->data_written = 2;

	    /* Volume attachment? */
	    if (audav) {
		if (nr < 3) {
		    (cdp+1)->vol = cdp->dat;
		}
	    }
	}
	break;

     default:
	cdp->state = 0;
	break;
    }
}


void audio_reset (void)
{
    memset (audio_channel, 0, sizeof audio_channel);
    audio_channel[0].per = 65535;
    audio_channel[1].per = 65535;
    audio_channel[2].per = 65535;
    audio_channel[3].per = 65535;

    last_audio_cycles = 0;
    next_sample_evtime = sample_evtime_interval;

    audperhack = 0;

    memset(sound_filter_state, 0, sizeof sound_filter_state);

    select_audio_interpolator(NULL);
}


static int sound_prefs_changed (void)
{
    return (changed_prefs.produce_sound != currprefs.produce_sound
	    || changed_prefs.stereo != currprefs.stereo
	    || changed_prefs.sound_freq != currprefs.sound_freq
	    || changed_prefs.sound_bits != currprefs.sound_bits);
}


void check_prefs_changed_audio (void)
{
    if (sound_available && sound_prefs_changed ()) {
	close_sound ();

	currprefs.produce_sound = changed_prefs.produce_sound;
	currprefs.stereo = changed_prefs.stereo;
	currprefs.sound_bits = changed_prefs.sound_bits;
	currprefs.sound_freq = changed_prefs.sound_freq;

	init_sound ();
	last_audio_cycles = cycles - 1;
	next_sample_evtime = sample_evtime_interval;
    }
}


void select_audio_interpolator(char *name)
{
    sample_prehandler = NULL;

    if (name == NULL || strcasecmp(name, "default") == 0) {
	sample_handler = sample16si_anti_handler;
	sample_prehandler = anti_sinc_prehandler;
    } else if (strcasecmp(name, "anti") == 0) {
	sample_handler = sample16si_anti_handler;
	sample_prehandler = anti_sinc_prehandler;
    } else if (strcasecmp(name, "sinc") == 0) {
	sample_handler = sample16si_sinc_handler;
	sample_prehandler = anti_sinc_prehandler;
    } else if (strcasecmp(name, "none") == 0) {
	sample_handler = sample16s_handler;
    } else {
	sample_handler = sample16si_anti_handler;
	sample_prehandler = anti_sinc_prehandler;
	fprintf(stderr, "\nUnknown interpolation mode: %s. Using default.\n", name);
    }
}


/* update_audio() emulates actions of audio state machine since it was last
   time called. One can assume it is called at least once per horizontal
   line and possibly more often. */
void update_audio (void)
{
    /* Number of cycles that has passed since last call to update_audio() */
    unsigned long n_cycles = cycles - last_audio_cycles;

    while (n_cycles > 0) {
	unsigned long best_evtime = n_cycles + 1;
	int i;
	unsigned long rounded;
	float f;

	for (i = 0; i < 4; i++) {
	    if (audio_channel[i].state != 0 && best_evtime > audio_channel[i].evtime)
		best_evtime = audio_channel[i].evtime;
	}

	/* next_sample_evtime >= 0 so floor() behaves as expected */
	rounded = floorf(next_sample_evtime);
	if ((next_sample_evtime - rounded) >= 0.5)
	    rounded++;

	if (best_evtime > rounded)
	    best_evtime = rounded;

	if (best_evtime > n_cycles)
	    best_evtime = n_cycles;
	
	/* Decrease time-to-wait counters */
	next_sample_evtime -= best_evtime;

	/* sample_prehandler makes it possible to compute effects with
	   accuracy of one bus cycle. sample_handler is only called when
	   a sample is outputted. */
	if (sample_prehandler != NULL)
	    sample_prehandler(best_evtime);

	for (i = 0; i < 4; i++)
	    audio_channel[i].evtime -= best_evtime;

	n_cycles -= best_evtime;

	/* Test if new sample needs to be outputted */
	if (rounded == best_evtime) {
	    /* Before the following addition, next_sample_evtime is in range
	       [-0.5, 0.5) */
	    next_sample_evtime += sample_evtime_interval;
	    (*sample_handler) ();
	}

	/* Call audio state machines if needed */
	for (i = 0; i < 4; i++) {
	    if (audio_channel[i].evtime == 0 && audio_channel[i].state != 0)
		audio_handler(i);
	}
    }

    last_audio_cycles = cycles - n_cycles;
}


void AUDxDAT (int nr, uae_u16 v)
{
    struct audio_channel_data *cdp = audio_channel + nr;

    update_audio ();

    cdp->dat = v;
    cdp->datpt = 0;

    if (cdp->state == 0 && !(INTREQR() & (0x80 << nr))) {
	cdp->state = 2;
	INTREQ(0x8000 | (0x80 << nr));
	/* data_written = 2 ???? */
	cdp->evtime = cdp->per;
    }
}


void AUDxLCH (int nr, uae_u16 v)
{
    update_audio ();

    audio_channel[nr].lc = (audio_channel[nr].lc & 0xffff) | ((uae_u32)v << 16);
}


void AUDxLCL (int nr, uae_u16 v)
{
    update_audio ();

    audio_channel[nr].lc = (audio_channel[nr].lc & ~0xffff) | (v & 0xFFFE);
}


void AUDxPER (int nr, uae_u16 v)
{
    update_audio ();

    if (v == 0)
	v = 65535;
    else if (v < 16) {
	/* With the risk of breaking super-cool players,
	   we limit the value to 16 to save cpu time on not so powerful
	   machines. robocop customs use low values for example. */
	if (!audperhack) {
	    audperhack = 1;
	    uade_send_debug("Eagleplayer inserted %d into aud%dper.", v, nr);
	}
	v = 16;
    }
    audio_channel[nr].per = v;
}


void AUDxLEN (int nr, uae_u16 v)
{
    update_audio ();

    audio_channel[nr].len = v;
}


void AUDxVOL (int nr, uae_u16 v)
{
    int v2 = v & 64 ? 63 : v & 63;

    update_audio ();

    audio_channel[nr].vol = v2;
}
